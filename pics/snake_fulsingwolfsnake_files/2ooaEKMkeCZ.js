if (self.CavalryLogger) { CavalryLogger.start_js(["FEt5G"]); }

__d("CavalryLoggerImpl",["Arbiter","Banzai","Bootloader","ImageTimingHelper","ISB","KillabyteProfilerConfig","NavigationTimingHelper","PageEvents","PageletEventConstsJS","PageletEventsHelper","PerfXLogger","ResourceTimingBootloaderHelper","ScriptPath","performance","performanceAbsoluteNow","__getTotalFactories","__getCompileTime","__getFactoryTime"],(function(a,b,c,d,e,f){__p&&__p();var g=b("KillabyteProfilerConfig").htmlProfilerModule,h=b("KillabyteProfilerConfig").profilerModule,i="cavalry",j=["t_start","t_paint","t_cstart"],k=window.CavalryLogger;Object.assign(k.prototype,{initializeInstrumentation:function(){__p&&__p();if(this.instrumentation_started)return;var c=this;b("Arbiter").subscribe("BigPipe/init",function(event,a){a.lid==c.lid&&a.arbiter&&(c._recordTTIEvent(a.arbiter),c._recordDisplayedEvent(a.arbiter),c._recordLoadedEvent(a.arbiter),c._recordPageletEventsTime(a.arbiter))});b("Arbiter").subscribe(b("PageEvents").BIGPIPE_ONLOAD,function(event,d){a.bigPipe&&c.lid===a.bigPipe.lid&&c.addPiggyback("cjs_factory_count_e2e",b("__getTotalFactories")()).addPiggyback("cjs_compile_time_e2e",b("__getCompileTime")()).addPiggyback("cjs_factory_time_e2e",b("__getFactoryTime")())});c.addPiggyback("script_path",b("ScriptPath").getScriptPath());this.is_detailed_profiler&&b("PageletEventsHelper").init();this.instrumentation_started=!0},_recordTTIEvent:function(a){__p&&__p();var b=this;a.subscribe("tti_bigpipe",function(event,a){if(a.lid==b.lid){if(a.metrics)for(var c in a.metrics)b.addPiggyback(c,a.metrics[c]);a.usageSnapshot&&(b.ttiUsageSnapshot=a.usageSnapshot);b._setTTIPhase(a.phase).measurePageLoad(!0,a.ts);b.setAbsTimeStamp("t_bigpipe_tti",a.ts,!0)}})},_recordDisplayedEvent:function(a){var b=this;a.subscribe("all_pagelets_displayed",function(event,a){a.lid===b.lid&&(a.usageSnapshot&&(b.ddUsageSnapshot=a.usageSnapshot),b.setAbsTimeStamp("t_marker_all_pagelets_displayed",a.ts,!0))})},_recordLoadedEvent:function(a){var b=this;a.subscribe("all_pagelets_loaded",function(event,a){a.lid===b.lid&&b.setAbsTimeStamp("t_marker_bigpipe_e2e",a.ts,!0)})},_recordPageletEventsTime:function(a){__p&&__p();if(this.is_detailed_profiler){var c=this;a.subscribe("pagelet_event",function(event,a){if(a.lid==c.lid){var d=a.id;c.events[d]=c.events[d]||{};c.events[d][a.event]=a.ts-window._cstart;a.event===b("PageletEventConstsJS").ARRIVE_END&&(c.events[d].phase=a.phase)}})}},_setTTIPhase:function(a){this.addPiggyback("tti_phase",a);return this},setTimeStamp:function(a,c,d,e){this.mark(a);var f=this.values.t_cstart||this.values.t_start;f=e?f+e:b("performanceAbsoluteNow")();this.setValue(a,f,c,d);this.tti_event&&a==this.tti_event&&this.measurePageLoad(c);return this},setAbsTimeStamp:function(a,b,c,d){this.setValue(a,b,c,d);this.tti_event&&a==this.tti_event&&this.measurePageLoad(c,b);return this},_logE2E:function(){var a={lid:this.lid,t_creport:b("performanceAbsoluteNow")(),cavalry_e2e:!0};b("ISB").token&&(a.fb_isb=b("ISB").token);for(var c=0;c<j.length;c++)a[j[c]]=this.values[j[c]];b("Banzai").post(i,a,{signal:!0,retry:!1});this.e2eLogged=!0},log:function(){__p&&__p();this.e2eLogged||this._logE2E();var a={lid:this.lid};b("ISB").token&&(a.fb_isb=b("ISB").token);this.addPiggyback("pagelet_events",b("PageletEventsHelper").getMetrics(this.lid));this.setValue("client_pixel_ratio_10x",parseInt((window.devicePixelRatio||1)*10,10));this._moveBootloaderData();a=babelHelpers["extends"]({t_creport:b("performanceAbsoluteNow")()},a,this.values,this.piggy_values);var c=window.__bodyWrapper;if(c.getCodeUsage&&h){if(!this.start||!this.e2e||!this.dd)throw new Error("Timestamps are missing in Cavalry. Please report this to the Web Speed team");var d=h.findUsedCSSSelectors(document,h.getDocumentStylesheets(document));d={js_calls:JSON.stringify(c.getCodeUsage()),css_selectors:JSON.stringify(d),bootloads:JSON.stringify(this._getBootloadsUntil(this.e2e))};g&&(d.html=JSON.stringify(g.getKillabyteHTMLData()));var e=babelHelpers["extends"]({},h.getDataForSnapshot(this.ddUsageSnapshot),{bootloads:JSON.stringify(this._getBootloadsUntil(this.dd))});d={e2e:d,dd:e};if(this.ttiUsageSnapshot){if(!this.tti)throw new Error("tti timestamp should always be present if we have usage data");d.tti=babelHelpers["extends"]({},h.getDataForSnapshot(this.ttiUsageSnapshot),{bootloads:JSON.stringify(this._getBootloadsUntil(this.tti))})}b("Arbiter").inform("cavalry_usage_data_collected",{usageData:d,lid:this.lid},b("Arbiter").BEHAVIOR_STATE);c.clearCodeUsage()}e=b("PerfXLogger").getPayload(a.lid);e&&this._logPerfXPiggybacks(a,e);b("Banzai").post(i,a,b("Banzai").VITAL);d=this.values;this.values={};this.piggy_values={};for(var c=0;c<j.length;c++)this.values[j[c]]=d[j[c]];b("Arbiter").inform("cavalry_log_sent",a,b("Arbiter").BEHAVIOR_STATE)},_logPerfXPiggybacks:function(a,b){a.perfx_page=b.perfx_page,a.perfx_page_type=b.perfx_page_type,a.perfx_tti=b.tti,a.perfx_e2e=b.e2e},_moveBootloaderData:function(){this.log_resources&&this.addPiggyback("resource_timing_bootloader",b("ResourceTimingBootloaderHelper").mergeBootloaderMetricsAndResourceTimings(this.piggy_values.resource_timing_bootloader,this.bootloader_metrics,!1,{}))},_collectMetrics:function(a){(!this.metric_collected||a)&&(this.metric_collected=!0,this.addPiggyback("tag",document.getElementsByTagName("*").length))},_getBootloadsUntil:function(a){return Object.entries(b("Bootloader").getBootloadedComponents()).filter(function(b){b[0];b=b[1];return b>=this.start&&b<=a}.bind(this)).map(function(a){var b=a[0];a[1];return b})},measurePageLoad:function(a,b){b?this.setAbsTimeStamp("t_tti",b,a):this.setTimeStamp("t_tti",a),this._collectMetrics(a)},collectBrowserTiming:function(a){if(b("performance").timing){this.start=b("performance").timing.navigationStart;this.tti=this.values.t_bigpipe_tti;this.dd=this.values.t_marker_all_pagelets_displayed;this.e2e=this.values.t_onload;a=b("NavigationTimingHelper").getNavTimings();this.addPiggyback("navigation_timing",a);this.log_resources&&(this.addPiggyback("resource_timing_bootloader",b("ResourceTimingBootloaderHelper").getMetrics(0,!1).data),this._collectTTIAndE2EWithImages())}},collectTimingForAsync:function(a,c){__p&&__p();if(!c)return;if(b("performance").timing&&b("performance").getEntriesByName){a=b("performance").getEntriesByName(c);if(a.length===0)return;this.start=b("performance").timing.navigationStart+a[0].startTime;this.tti=this.values.t_bigpipe_tti;this.e2e=this.values.t_onload;c=b("NavigationTimingHelper").getAsyncRequestTimings(c);this.addPiggyback("navigation_timing",c);this.log_resources&&(this.addPiggyback("resource_timing_bootloader",b("ResourceTimingBootloaderHelper").getMetrics(a[0].startTime,!1).data),this._collectTTIAndE2EWithImages())}},_collectTTIAndE2EWithImages:function(){var a=b("performance").timing.navigationStart,c=this.values.t_bigpipe_tti,d=this.values.t_marker_bigpipe_e2e,e=b("ImageTimingHelper").getImageTimings(this.lid);c=b("ResourceTimingBootloaderHelper").getLastTTIAndE2EImageResponseEnds(c,d,e);!isNaN(c.TTI)&&c.TTI!==a&&this.setAbsTimeStamp("t_tti_with_images",c.TTI);!isNaN(c.E2E)&&c.E2E!==a&&this.setAbsTimeStamp("t_marker_bigpipe_e2e_with_images",c.E2E)}});Object.assign(k,{startInstrumentation:function(){for(var a in k.instances){var b=k.instances[a];b.initializeInstrumentation();"t_tti"in b.values&&b.measurePageLoad(!1,b.values.t_tti)}},hookLogOnLoad:function(a){b("Arbiter").registerCallback(function(){k.setPageID(a),k.instances[a].log()},[b("PageEvents").NATIVE_ONLOAD])}});e.exports=k}),null);